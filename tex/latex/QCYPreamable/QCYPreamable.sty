\NeedsTeXFormat{LaTeX2e}[2019/05/03] % 2019/05/03 is need for \NewDocumentEnvironment
\ProvidesPackage{QCYPreamable}[2022/07/07 QianCY preamable v0.4]

% 待了解：tabu

% Deal with the package `program', which is included in `Springer Nature LaTeX Template'
\@ifpackageloaded{program}{
    \normalbaroutside
    \let\programR\R
    \let\R\undefined
}{\relax}

\RequirePackage{expl3,xparse}
\RequirePackage{l3keys2e}

\newif\ifDraftMode
\DraftModefalse

\ExplSyntaxOn
\bool_new:N  \l__QCYPreamable_AutoTheorem_bool
\bool_set:Nn \l__QCYPreamable_AutoTheorem_bool \c_false_bool
\keys_define:nn { QCYPreamable } {
    biblatex          .code:n = {\PassOptionsToPackage{#1}{biblatex}},
    hyperref          .code:n = {\PassOptionsToPackage{#1}{hyperref}},
    cleveref          .code:n = {\PassOptionsToPackage{#1}{cleveref}},
    url               .code:n = {\PassOptionsToPackage{#1}{url     }},
    printbibliography .code:n = {\AtEndDocument{\printbibliography}},
    draft             .code:n = {\DraftModetrue},
    AutoTheorem       .code:n = {
        \bool_set:Nn \l__QCYPreamable_AutoTheorem_bool \c_true_bool
    },
    DraftSecBreak     .code:n = { % 如果在草稿模式下，那么每节前分页，以节省打印纸张。
                                    \ifDraftMode
                                        \AtEndOfPackage{
                                            \pretocmd{\section}{\clearpage}{}{\GenericWarning{Error when prepending `\backslash clearpage' to command `\backslash section'}}
                                        }
                                    \fi
                                },
}
\ProcessKeysOptions { QCYPreamable }

\RequirePackage{amsmath,amsthm,amssymb,mathtools} % Basic Packages
\RequirePackage{regexpatch} % 替代etoolbox提供各种钩子。

% Fonts
\RequirePackage{mathrsfs} % 花体 \mathscr
\RequirePackage{bbm}      % 空心体 \mathbbm
\RequirePackage{dsfont}   % 空心体 \mathds

% Labeling
% 为了造case环境
\RequirePackage{enumitem}
% 支持子图，引用为Figure 1(a)
\RequirePackage[labelformat=simple]{subcaption}
\renewcommand*\thesubfigure{(\alph{subfigure})}
\renewcommand*\thesubtable{(\alph{subtable})}

% Citation
\RequirePackage[isbn=false]{biblatex} % style=alphabetic, numeric, authoryear.
\ExecuteBibliographyOptions
{
    maxcitenames=3, maxbibnames=100, minnames=3,
}
\AtEveryBibitem{
    \clearfield{issn}
}
\RequirePackage{hyperref}
\RequirePackage{cleveref}
\ifDraftMode
    \RequirePackage[notref,notcite]{showkeys}
\fi

\DeclareRobustCommand{\ProofStyle}[2][\square]{
    \cspreto{#2}{\pushQED{{\hfill\ensuremath{#1}}}}
    \cspreto{end#2}{\popQED}
}

% \DeclareRobustCommand{\ProofStyle}[2][\square]{
%     \cspreto{#2}{\pushQED{\qed}\renewcommand*{\qedsymbol}{\ensuremath{#1}}}
%     \cspreto{end#2}{\popQED}
% }

% Environments
\newtheoremstyle{ModifiedRemark}
    {0.5\topsep}             % ABOVE SPACE
    {0.5\topsep}             % BELOW SPACE
    {\normalfont}            % BODY FONT
    {0pt}                    % INDENT (empty value is the same as 0pt)
    {\scshape}               % HEAD FONT % Different from Environment{remark}
    {.}                      % HEAD PUNCT
    {5pt plus 1pt minus 1pt} % HEAD SPACE
    {}                       % CUSTOM-HEAD-SPEC

\bool_if:NT \l__QCYPreamable_AutoTheorem_bool
{
    \theoremstyle{plain}
    \newtheorem{theorem}{Theorem}[section]
    \newtheorem{proposition}[theorem]{Proposition}
    \newtheorem{corollary}[theorem]{Corollary}
    \newtheorem{lemma}[theorem]{Lemma}
    \newtheorem{conjecture}[theorem]{Conjecture}
    \newtheorem{question}[theorem]{Question}
    \theoremstyle{definition}
    \newtheorem{definition}[theorem]{Definition}
    \theoremstyle{remark}
    \newtheorem{example}[theorem]{Example}
    \newtheorem{remark}[theorem]{Remark}
    \ProofStyle[\Diamond]{example}
    \ProofStyle[\Diamond]{remark}
    \theoremstyle{ModifiedRemark}
    \newtheorem{claim}{Claim}[theorem]
    % 告诉cleveref如何引用环境
    \crefname{conjecture}{Conjecture}{Conjectures}
    \crefname{example}{Example}{Examples}
    \crefname{claim}{Claim}{Claims}

    \NewDocumentEnvironment{bordmatrix}{+b}
    {
        \renewcommand{\\}{\cr}
        \bordermatrix{#1}
    }{}

    \NewDocumentEnvironment{comment}{+b}{}{}

    \newcommand{\nameofcase}[1]{\scshape Case\ \normalfont #1.}
    \newlist{case}{enumerate}{5}
    \setlist[case]{
        format=\nameofcase,
        label*=.\arabic*,
        align=left,
        left=0pt .. 0pt,
        labelsep=5pt plus 1pt minus 1pt,
        itemindent=!,
        listparindent=\parindent
    }
    \setlist[case,1]{label=\arabic*}
    \crefname{casei}{Case}{Cases}
    \crefname{caseii}{Case}{Cases}
    \crefname{caseiii}{Case}{Cases}
    \crefname{caseiv}{Case}{Cases}
    \crefname{casev}{Case}{Cases}
    % 这段代码有bug
    % \ExplSyntaxOn
    % \int_new:N \l_QCYPreamable_adder_int
    % \int_set:Nn \l_QCYPreamable_adder_int 1
    % \int_while_do:nn {\l_QCYPreamable_adder_int <= 5}
    % {
    %     \crefname{case \int_to_roman:n {\l_QCYPreamable_adder_int}}{Case}{Cases}
    %     \int_incr:N \l_QCYPreamable_adder_int
    % }
    % \ExplSyntaxOff
}

% New commands
\providecommand*{\email}[1]{\href{mailto:#1}{\nolinkurl{#1}}}
\providecommand*{\keywords}{\par\bigskip\noindent\textbf{Keywords: }} % 用来在摘要里加上keywords
\providecommand*{\numberthis}{\refstepcounter{equation}\tag{\theequation}} % 用来在align*加入tag
\providecommand*{\eqgap}{\mathrel{\phantom{=}}} % 空白的等号
\providecommand*{\setto}{\coloneqq}

\ExplSyntaxOff
\endinput